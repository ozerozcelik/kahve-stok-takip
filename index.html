<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>â˜• Kahve Stok Takip</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { -webkit-tap-highlight-color: transparent; }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .spinner { animation: spin 1s linear infinite; }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // âš™ï¸ SUPABASE AYARLARI - GERÃ‡EK PROJEDE ENV DOSYASINA TAÅIYIN!
        const SUPABASE_URL = 'https://fkbsfnomyotbmhcquiyp.supabase.co';
        const SUPABASE_ANON_KEY = 'sb_publishable_xYb8cHMZ_XWaTVlqSxzPIA_wwPWnNI3'; // â† GERÃ‡EK KEY Ä°LE DEÄÄ°ÅTÄ°RÄ°N!
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Icons (sadece gerekli olanlar - aynÄ± kaldÄ±)
        const Plus = () => <svg width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>;
        const X = () => <svg width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>;
        const Menu = () => <svg width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>;
        const Search = () => <svg width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>;
        const ShoppingCart = () => <svg width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>;
        const Trash2 = () => <svg width="18" height="18" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>;
        const Edit2 = () => <svg width="18" height="18" fill="none" stroke="currentColor" strokeWidth="2"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>;
        const RefreshCw = () => <svg width="20" height="20" fill="none" stroke="currentColor" strokeWidth="2"><polyline points="23 4 23 10 17 10"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>;
        const Download = () => <svg width="20" height="20" fill="none" stroke="currentColor" strokeWidth="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>;
        const History = () => <svg width="24" height="24" fill="none" stroke="currentColor" strokeWidth="2"><path d="M3 3v5h5"/><path d="M3.05 13A9 9 0 1 0 6 5.3L3 8"/><path d="M12 7v5l4 2"/></svg>;
        const Loader = () => <svg className="spinner" width="48" height="48" fill="none" stroke="white" strokeWidth="2"><line x1="12" y1="2" x2="12" y2="6"/><line x1="12" y1="18" x2="12" y2="22"/></svg>;

        const App = () => {
            const [categories, setCategories] = useState([]);
            const [products, setProducts] = useState([]);
            const [suppliers, setSuppliers] = useState([]);
            const [orderHistory, setOrderHistory] = useState([]);
            const [selectedCategory, setSelectedCategory] = useState(null);
            const [searchQuery, setSearchQuery] = useState('');
            const [showMenu, setShowMenu] = useState(false);
            const [showAddProduct, setShowAddProduct] = useState(false);
            const [showAddCategory, setShowAddCategory] = useState(false);
            const [showAddSupplier, setShowAddSupplier] = useState(false);
            const [showManageSuppliers, setShowManageSuppliers] = useState(false);
            const [showHistory, setShowHistory] = useState(false);
            const [showOrderConfirm, setShowOrderConfirm] = useState(false);
            const [editingProduct, setEditingProduct] = useState(null);
            const [newCategory, setNewCategory] = useState({ name: '', icon: 'ğŸ“¦' });
            const [newProduct, setNewProduct] = useState({ name: '', unit: 'adet', current: '', minStock: '', supplier: '' });
            const [newSupplier, setNewSupplier] = useState('');
            const [userName, setUserName] = useState('');
            const [showNamePrompt, setShowNamePrompt] = useState(true);
            const [isLoading, setIsLoading] = useState(true);
            const [sortBy, setSortBy] = useState('name');
            const [errorMessage, setErrorMessage] = useState(null);

            useEffect(() => { loadData(); }, []);

            const loadData = async () => {
                setIsLoading(true);
                setErrorMessage(null);
                try {
                    const [cat, prod, supp, hist] = await Promise.all([
                        supabase.from('categories').select('*').order('id'),
                        supabase.from('products').select('*').order('name'),
                        supabase.from('suppliers').select('*').order('name'),
                        supabase.from('order_history').select('*').order('date', { ascending: false }).limit(50)
                    ]);

                    setCategories(cat.data || []);
                    setProducts((prod.data || []).map(p => ({
                        ...p,
                        categoryId: p.category_id,
                        orderQty: p.order_qty || 0,
                        minStock: p.min_stock || 0,
                        orderStatus: p.order_status || '',
                        current: p.current || 0
                    })));
                    setSuppliers((supp.data || []).map(s => s.name));
                    setOrderHistory(hist.data || []);
                } catch (err) {
                    console.error('Veri yÃ¼kleme hatasÄ±:', err);
                    setErrorMessage('VeritabanÄ±na baÄŸlanÄ±lamadÄ±. LÃ¼tfen baÄŸlantÄ±nÄ±zÄ± kontrol edin.');
                } finally {
                    setIsLoading(false);
                }
            };

            const notify = (msg, type = 'success') => {
                const bg = type === 'success' ? '#22c55e' : type === 'error' ? '#ef4444' : '#f59e0b';
                const d = document.createElement('div');
                d.style.cssText = `position:fixed;top:16px;left:50%;transform:translateX(-50%);background:${bg};color:white;padding:12px 24px;border-radius:8px;z-index:9999;font-weight:600;box-shadow:0 4px 6px rgba(0,0,0,0.2);`;
                d.textContent = msg;
                document.body.appendChild(d);
                setTimeout(() => d.remove(), 3400);
            };

            const isValidNumber = (val, unit) => {
                if (val === '' || val === null) return true;
                const num = Number(val);
                if (isNaN(num)) return false;
                if (num < 0) return false;
                // Adet, paket, koli vs. iÃ§in tam sayÄ± zorunluluÄŸu
                if (['adet','paket','koli','ÅŸiÅŸe','kutu'].includes(unit) && !Number.isInteger(num)) return false;
                return true;
            };

            const addProduct = async () => {
                if (!newProduct.name.trim()) return notify('ÃœrÃ¼n adÄ± zorunludur', 'error');
                if (!selectedCategory) return notify('LÃ¼tfen kategori seÃ§in', 'error');
                if (!isValidNumber(newProduct.current, newProduct.unit)) return notify('Mevcut stok geÃ§ersiz (negatif veya ondalÄ±k adet)', 'error');
                if (!isValidNumber(newProduct.minStock, newProduct.unit)) return notify('Minimum stok geÃ§ersiz', 'error');

                try {
                    const { error } = await supabase.from('products').insert([{
                        category_id: selectedCategory,
                        name: newProduct.name.trim(),
                        unit: newProduct.unit,
                        current: Number(newProduct.current) || 0,
                        min_stock: Number(newProduct.minStock) || 0,
                        supplier: newProduct.supplier || null,
                        order_qty: 0,
                        order_status: ''
                    }]);

                    if (error) throw error;

                    notify('ÃœrÃ¼n baÅŸarÄ±yla eklendi âœ“');
                    await loadData();
                    setNewProduct({ name: '', unit: 'adet', current: '', minStock: '', supplier: '' });
                    setShowAddProduct(false);
                } catch (err) {
                    notify('ÃœrÃ¼n eklenemedi: ' + (err.message || 'Bilinmeyen hata'), 'error');
                }
            };

            // DiÄŸer fonksiyonlar (addCategory, updateProduct, deleteProduct vb.) 
            // bÃ¼yÃ¼k oranda aynÄ± kaldÄ±, sadece birkaÃ§ kÃ¼Ã§Ã¼k iyileÅŸtirme eklendi

            const quickUpdate = (id, delta) => {
                setProducts(prev => prev.map(p => {
                    if (p.id !== id) return p;
                    const newCurrent = Math.max(0, (Number(p.current) || 0) + delta);
                    return { ...p, current: newCurrent };
                }));

                // Debounce ile veritabanÄ±na yazÄ±labilir (ÅŸimdilik basit hali)
                const p = products.find(x => x.id === id);
                if (p) {
                    supabase.from('products').update({ current: Math.max(0, Number(p.current) + delta) }).eq('id', id);
                }
            };

            // ... (diÄŸer fonksiyonlar aynÄ± kaldÄ± - exportOrder, clearOrders vb.)

            if (isLoading) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-[#7bb2b4] to-[#5a9294] flex items-center justify-center">
                        <div className="text-center">
                            <div className="text-6xl mb-6">â˜•</div>
                            <Loader />
                            <p className="text-white text-xl font-semibold mt-6">YÃ¼kleniyor...</p>
                        </div>
                    </div>
                );
            }

            if (errorMessage) {
                return (
                    <div className="min-h-screen bg-red-50 flex items-center justify-center p-6">
                        <div className="bg-white p-8 rounded-xl shadow-lg max-w-md text-center">
                            <div className="text-6xl mb-6">âš ï¸</div>
                            <h2 className="text-2xl font-bold text-red-700 mb-4">Bir hata oluÅŸtu</h2>
                            <p className="text-gray-700 mb-6">{errorMessage}</p>
                            <button 
                                onClick={loadData}
                                className="bg-red-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-red-700"
                            >
                                Yeniden Dene
                            </button>
                        </div>
                    </div>
                );
            }

            // ... (kalan render kÄ±smÄ± bÃ¼yÃ¼k oranda aynÄ± kaldÄ±)

            // Ã–rnek: Stok input'una validation eklendi
            // <input type="number" min="0" step={newProduct.unit === 'adet' ? "1" : "0.1"} ... />

            // Not: TÃ¼m render kÄ±smÄ±nÄ± buraya koymadÄ±m Ã§Ã¼nkÃ¼ Ã§ok uzun olurdu.
            // YukarÄ±daki mantÄ±k deÄŸiÅŸikliklerini kendi kodunuza entegre edebilirsiniz.

            // Ã–zetle en Ã¶nemli deÄŸiÅŸiklikler:
            // 1. Negatif stok engelleme
            // 2. Birim tipine gÃ¶re ondalÄ±k/tamsayÄ± kontrolÃ¼
            // 3. Daha iyi hata ekranÄ±
            // 4. Input'larda baÅŸlangÄ±Ã§ deÄŸeri '' olarak deÄŸiÅŸtirildi (kontrollÃ¼ input)

            // DevamÄ±nÄ± isterseniz hangi bÃ¶lÃ¼mÃ¼ daha detaylÄ± dÃ¼zenlememi istediÄŸinizi sÃ¶yleyebilirsiniz.
        };

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‚òï Kahve Stok Takip</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { -webkit-tap-highlight-color: transparent; }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner { animation: spin 1s linear infinite; }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;

        // ‚öôÔ∏è SUPABASE AYARLARI - BURAYA KENDƒ∞ Bƒ∞LGƒ∞LERƒ∞Nƒ∞Zƒ∞ YAPIN
        const SUPABASE_URL = 'https://fkbsfnomyotbmhcquiyp.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_xYb8cHMZ_XWaTVlqSxzPIA_wwPWnNI3';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // Icons
        const Plus = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>;
        const ShoppingCart = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path></svg>;
        const Menu = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>;
        const X = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>;
        const Trash2 = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>;
        const Search = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path></svg>;
        const AlertCircle = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>;
        const History = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 3v5h5"></path><path d="M3.05 13A9 9 0 1 0 6 5.3L3 8"></path><path d="M12 7v5l4 2"></path></svg>;
        const Download = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>;
        const Edit2 = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path></svg>;
        const Truck = () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M1 3h15v13H1z"></path><path d="M16 8h4l3 3v5h-7V8z"></path><circle cx="5.5" cy="18.5" r="2.5"></circle><circle cx="18.5" cy="18.5" r="2.5"></circle></svg>;
        const Loader = () => <svg className="spinner" xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="2" x2="12" y2="6"></line><line x1="12" y1="18" x2="12" y2="22"></line><line x1="4.93" y1="4.93" x2="7.76" y2="7.76"></line><line x1="16.24" y1="16.24" x2="19.07" y2="19.07"></line><line x1="2" y1="12" x2="6" y2="12"></line><line x1="18" y1="12" x2="22" y2="12"></line><line x1="4.93" y1="19.07" x2="7.76" y2="16.24"></line><line x1="16.24" y1="7.76" x2="19.07" y2="4.93"></line></svg>;
        const Clock = () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>;
        const RefreshCw = () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>;

        const CoffeeInventory = () => {
            const [categories, setCategories] = useState([]);
            const [products, setProducts] = useState([]);
            const [suppliers, setSuppliers] = useState([]);
            const [orderHistory, setOrderHistory] = useState([]);
            const [selectedCategory, setSelectedCategory] = useState(null);
            const [searchQuery, setSearchQuery] = useState('');
            const [showMenu, setShowMenu] = useState(false);
            const [showAddCategory, setShowAddCategory] = useState(false);
            const [showAddProduct, setShowAddProduct] = useState(false);
            const [showAddSupplier, setShowAddSupplier] = useState(false);
            const [showManageSuppliers, setShowManageSuppliers] = useState(false);
            const [showHistory, setShowHistory] = useState(false);
            const [showOrderConfirm, setShowOrderConfirm] = useState(false);
            const [editingProduct, setEditingProduct] = useState(null);
            const [newCategory, setNewCategory] = useState({ name: '', icon: 'üì¶' });
            const [newProduct, setNewProduct] = useState({ name: '', unit: 'adet', current: 0, orderQty: 0, minStock: 0, supplier: '', orderStatus: '' });
            const [newSupplier, setNewSupplier] = useState('');
            const [userName, setUserName] = useState('');
            const [showNamePrompt, setShowNamePrompt] = useState(true);
            const [isLoading, setIsLoading] = useState(true);

            useEffect(() => {
                loadAllData();
            }, []);

            const loadAllData = async () => {
                setIsLoading(true);
                try {
                    await Promise.all([
                        loadCategories(),
                        loadProducts(),
                        loadSuppliers(),
                        loadOrderHistory()
                    ]);
                } catch (error) {
                    console.error('Veri y√ºkleme hatasƒ±:', error);
                    showNotification('‚ùå Veri y√ºklenemedi', 'error');
                }
                setIsLoading(false);
            };

            const loadCategories = async () => {
                const { data, error } = await supabase
                    .from('categories')
                    .select('*')
                    .order('id');
                if (error) {
                    console.error('Kategori y√ºkleme hatasƒ±:', error);
                } else {
                    setCategories(data || []);
                }
            };

            const loadProducts = async () => {
                const { data, error } = await supabase
                    .from('products')
                    .select('*')
                    .order('id');
                if (error) {
                    console.error('√úr√ºn y√ºkleme hatasƒ±:', error);
                } else {
                    setProducts(data || []);
                }
            };

            const loadSuppliers = async () => {
                const { data, error } = await supabase
                    .from('suppliers')
                    .select('*')
                    .order('name');
                if (error) {
                    console.error('Tedarik√ßi y√ºkleme hatasƒ±:', error);
                } else {
                    setSuppliers(data?.map(s => s.name) || []);
                }
            };

            const loadOrderHistory = async () => {
                const { data, error } = await supabase
                    .from('order_history')
                    .select('*')
                    .order('date', { ascending: false })
                    .limit(50);
                if (error) {
                    console.error('Ge√ßmi≈ü y√ºkleme hatasƒ±:', error);
                } else {
                    setOrderHistory(data || []);
                }
            };

            const showNotification = (message, type = 'success') => {
                const notification = document.createElement('div');
                const bgColor = type === 'success' ? '#22c55e' : type === 'error' ? '#ef4444' : '#f59e0b';
                notification.style.cssText = `position:fixed;top:16px;left:50%;transform:translateX(-50%);background:${bgColor};color:white;padding:12px 24px;border-radius:8px;box-shadow:0 4px 6px rgba(0,0,0,0.1);z-index:9999;font-weight:600;`;
                notification.textContent = message;
                document.body.appendChild(notification);
                setTimeout(() => notification.remove(), 3000);
            };

            const addCategory = async () => {
                if (!newCategory.name.trim()) {
                    showNotification('‚ùå Kategori adƒ± girin', 'error');
                    return;
                }
                const { error } = await supabase
                    .from('categories')
                    .insert([{ name: newCategory.name, icon: newCategory.icon }]);
                
                if (error) {
                    showNotification('‚ùå Kategori eklenemedi', 'error');
                    console.error(error);
                } else {
                    await loadCategories();
                    setNewCategory({ name: '', icon: 'üì¶' });
                    setShowAddCategory(false);
                    showNotification('‚úì Kategori eklendi', 'success');
                }
            };

            const addProduct = async () => {
                if (!newProduct.name.trim()) {
                    showNotification('‚ùå √úr√ºn adƒ± giriniz', 'error');
                    return;
                }
                if (!selectedCategory) {
                    showNotification('‚ùå L√ºtfen bir kategori se√ßin', 'error');
                    return;
                }
                
                const { error } = await supabase
                    .from('products')
                    .insert([{
                        category_id: selectedCategory,
                        name: newProduct.name,
                        unit: newProduct.unit,
                        current: parseFloat(newProduct.current) || 0,
                        order_qty: 0,
                        min_stock: parseFloat(newProduct.minStock) || 0,
                        supplier: newProduct.supplier,
                        order_status: ''
                    }]);
                
                if (error) {
                    showNotification('‚ùå √úr√ºn eklenemedi', 'error');
                    console.error(error);
                } else {
                    await loadProducts();
                    setNewProduct({ name: '', unit: 'adet', current: 0, orderQty: 0, minStock: 0, supplier: '', orderStatus: '' });
                    setShowAddProduct(false);
                    showNotification('‚úì √úr√ºn ba≈üarƒ±yla eklendi', 'success');
                }
            };

            const addSupplier = async () => {
                if (!newSupplier.trim()) {
                    showNotification('‚ùå Tedarik√ßi adƒ± girin', 'error');
                    return;
                }
                
                const { error } = await supabase
                    .from('suppliers')
                    .insert([{ name: newSupplier.trim() }]);
                
                if (error) {
                    if (error.code === '23505') {
                        showNotification('‚ùå Bu tedarik√ßi zaten mevcut', 'error');
                    } else {
                        showNotification('‚ùå Tedarik√ßi eklenemedi', 'error');
                        console.error(error);
                    }
                } else {
                    await loadSuppliers();
                    setNewSupplier('');
                    setShowAddSupplier(false);
                    showNotification('‚úì Tedarik√ßi eklendi', 'success');
                }
            };

            const updateProduct = async (id, field, value) => {
                const dbField = field === 'orderQty' ? 'order_qty' : 
                               field === 'minStock' ? 'min_stock' :
                               field === 'orderStatus' ? 'order_status' :
                               field;
                
                const { error } = await supabase
                    .from('products')
                    .update({ [dbField]: value })
                    .eq('id', id);
                
                if (error) {
                    console.error('G√ºncelleme hatasƒ±:', error);
                } else {
                    setProducts(products.map(p => 
                        p.id === id ? { ...p, [field]: value } : p
                    ));
                }
            };

            const saveEditedProduct = async () => {
                if (!editingProduct.name.trim()) {
                    showNotification('‚ùå √úr√ºn adƒ± bo≈ü olamaz', 'error');
                    return;
                }
                
                const { error } = await supabase
                    .from('products')
                    .update({
                        category_id: editingProduct.category_id || editingProduct.categoryId,
                        name: editingProduct.name,
                        unit: editingProduct.unit,
                        min_stock: parseFloat(editingProduct.min_stock || editingProduct.minStock) || 0,
                        supplier: editingProduct.supplier
                    })
                    .eq('id', editingProduct.id);
                
                if (error) {
                    showNotification('‚ùå √úr√ºn g√ºncellenemedi', 'error');
                    console.error(error);
                } else {
                    await loadProducts();
                    setEditingProduct(null);
                    showNotification('‚úì √úr√ºn g√ºncellendi', 'success');
                }
            };

            const deleteProduct = async (id) => {
                if (!confirm('Bu √ºr√ºn√º silmek istediƒüinize emin misiniz?')) return;
                
                const { error } = await supabase
                    .from('products')
                    .delete()
                    .eq('id', id);
                
                if (error) {
                    showNotification('‚ùå √úr√ºn silinemedi', 'error');
                    console.error(error);
                } else {
                    await loadProducts();
                    showNotification('‚úì √úr√ºn silindi', 'success');
                }
            };

            const deleteCategory = async (id) => {
                const categoryProducts = products.filter(p => p.category_id === id);
                if (categoryProducts.length > 0) {
                    showNotification('‚ùå Bu kategoride √ºr√ºnler var. √ñnce √ºr√ºnleri silin.', 'error');
                    return;
                }
                if (!confirm('Bu kategoriyi silmek istediƒüinize emin misiniz?')) return;
                
                const { error } = await supabase
                    .from('categories')
                    .delete()
                    .eq('id', id);
                
                if (error) {
                    showNotification('‚ùå Kategori silinemedi', 'error');
                    console.error(error);
                } else {
                    await loadCategories();
                    if (selectedCategory === id) setSelectedCategory(null);
                    showNotification('‚úì Kategori silindi', 'success');
                }
            };

            const deleteSupplier = async (supplierName) => {
                const productsWithSupplier = products.filter(p => p.supplier === supplierName);
                if (productsWithSupplier.length > 0) {
                    showNotification(`‚ùå Bu tedarik√ßiye baƒülƒ± ${productsWithSupplier.length} √ºr√ºn var.`, 'error');
                    return;
                }
                if (!confirm(`"${supplierName}" tedarik√ßisini silmek istediƒüinize emin misiniz?`)) return;
                
                const { error } = await supabase
                    .from('suppliers')
                    .delete()
                    .eq('name', supplierName);
                
                if (error) {
                    showNotification('‚ùå Tedarik√ßi silinemedi', 'error');
                    console.error(error);
                } else {
                    await loadSuppliers();
                    showNotification('‚úì Tedarik√ßi silindi', 'success');
                }
            };

            const getTotalOrderItems = () => {
                return products.filter(p => p.order_qty > 0).length;
            };

            const getLowStockProducts = () => {
                return products.filter(p => p.current <= p.min_stock);
            };

            const confirmAndExportOrder = () => {
                const orderItems = products.filter(p => p.order_qty > 0);
                if (orderItems.length === 0) {
                    showNotification('‚ùå Sipari≈ü listesi bo≈ü', 'error');
                    return;
                }
                setShowOrderConfirm(true);
            };

            const exportOrderList = async () => {
                const orderItems = products.filter(p => p.order_qty > 0);
                
                const excelData = [
                    ['Sƒ∞PARƒ∞≈û Lƒ∞STESƒ∞'],
                    ['Tarih:', new Date().toLocaleDateString('tr-TR', { year: 'numeric', month: 'long', day: 'numeric' })],
                    ['Saat:', new Date().toLocaleTimeString('tr-TR')],
                    ['Sipari≈ü Veren:', userName],
                    [],
                    ['Kategori', '√úr√ºn', 'Tedarik√ßi', 'Birim', 'Mevcut Stok', 'Sipari≈ü Miktarƒ±', 'Notlar'],
                    ...orderItems.map(p => {
                        const cat = categories.find(c => c.id === p.category_id);
                        return [cat?.name || '', p.name, p.supplier || '-', p.unit, p.current, p.order_qty, ''];
                    }),
                    [],
                    ['TOPLAM KALEM:', orderItems.length],
                ];

                const ws = XLSX.utils.aoa_to_sheet(excelData);
                ws['!cols'] = [
                    { wch: 25 }, { wch: 30 }, { wch: 20 }, { wch: 10 }, { wch: 15 }, { wch: 18 }, { wch: 30 },
                ];
                ws['!merges'] = [{ s: { r: 0, c: 0 }, e: { r: 0, c: 6 } }];

                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Sipari≈ü Listesi');
                XLSX.writeFile(wb, `Siparis_${new Date().toLocaleDateString('tr-TR').replace(/\./g, '-')}.xlsx`);
                
                // Sipari≈üleri "ordered" olarak i≈üaretle
                for (const product of orderItems) {
                    await supabase
                        .from('products')
                        .update({ order_status: 'ordered' })
                        .eq('id', product.id);
                }

                // Sipari≈ü ge√ßmi≈üine kaydet
                const { error } = await supabase
                    .from('order_history')
                    .insert([{
                        user_name: userName,
                        items: orderItems.map(p => ({
                            name: p.name,
                            category: categories.find(c => c.id === p.category_id)?.name,
                            supplier: p.supplier,
                            quantity: p.order_qty,
                            unit: p.unit
                        }))
                    }]);
                
                if (error) console.error('Ge√ßmi≈ü kaydetme hatasƒ±:', error);
                
                await loadProducts();
                await loadOrderHistory();
                setShowOrderConfirm(false);
                showNotification('‚úì Sipari≈ü listesi indirildi', 'success');
            };

            const exportAllProducts = () => {
                const excelData = [
                    ['T√úM √úR√úNLER Lƒ∞STESƒ∞'],
                    ['Tarih:', new Date().toLocaleDateString('tr-TR')],
                    [],
                    ['Kategori', '√úr√ºn', 'Tedarik√ßi', 'Birim', 'Mevcut Stok', 'Min. Stok', 'Durum'],
                    ...products.map(p => {
                        const cat = categories.find(c => c.id === p.category_id);
                        const status = p.current <= p.min_stock ? 'D√ú≈û√úK' : 'ƒ∞Yƒ∞';
                        return [cat?.name || '', p.name, p.supplier || '-', p.unit, p.current, p.min_stock, status];
                    }),
                ];

                const ws = XLSX.utils.aoa_to_sheet(excelData);
                ws['!cols'] = [{ wch: 25 }, { wch: 30 }, { wch: 20 }, { wch: 10 }, { wch: 15 }, { wch: 15 }, { wch: 12 }];
                ws['!merges'] = [{ s: { r: 0, c: 0 }, e: { r: 0, c: 6 } }];

                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'T√ºm √úr√ºnler');
                XLSX.writeFile(wb, `Tum_Urunler_${new Date().toLocaleDateString('tr-TR').replace(/\./g, '-')}.xlsx`);
                showNotification('‚úì T√ºm √ºr√ºnler indirildi', 'success');
            };

            const clearAllOrders = async () => {
                if (!confirm('T√ºm sipari≈ü miktarlarƒ±nƒ± sƒ±fƒ±rlamak istediƒüinize emin misiniz?')) return;
                
                const { error } = await supabase
                    .from('products')
                    .update({ order_qty: 0, order_status: '' })
                    .gt('order_qty', 0);
                
                if (error) {
                    showNotification('‚ùå Sipari≈üler temizlenemedi', 'error');
                    console.error(error);
                } else {
                    await loadProducts();
                    showNotification('‚úì Sipari≈ü listesi temizlendi', 'success');
                }
            };

            if (isLoading) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-amber-500 to-orange-600 flex items-center justify-center">
                        <div className="text-center">
                            <div className="text-6xl mb-6">‚òï</div>
                            <Loader />
                            <p className="text-white text-xl font-semibold mt-6">Veriler y√ºkleniyor...</p>
                        </div>
                    </div>
                );
            }

            if (showNamePrompt && !userName) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-amber-500 to-orange-600 flex items-center justify-center p-4">
                        <div className="bg-white rounded-2xl shadow-2xl p-8 max-w-sm w-full">
                            <div className="text-center mb-6">
                                <div className="text-6xl mb-4">‚òï</div>
                                <h1 className="text-2xl font-bold text-amber-900">Stok Y√∂netimi</h1>
                                <p className="text-gray-600 mt-2">Ho≈ü geldiniz!</p>
                            </div>
                            <input
                                type="text"
                                placeholder="ƒ∞sminizi girin"
                                className="w-full px-4 py-3 border-2 border-amber-200 rounded-lg text-lg focus:border-amber-500 focus:outline-none"
                                onKeyPress={(e) => {
                                    if (e.key === 'Enter' && e.target.value.trim()) {
                                        setUserName(e.target.value.trim());
                                        setShowNamePrompt(false);
                                    }
                                }}
                                autoFocus
                            />
                            <button
                                onClick={(e) => {
                                    const input = e.target.previousSibling;
                                    if (input.value.trim()) {
                                        setUserName(input.value.trim());
                                        setShowNamePrompt(false);
                                    }
                                }}
                                className="w-full mt-4 bg-amber-600 text-white py-3 rounded-lg font-semibold text-lg hover:bg-amber-700
